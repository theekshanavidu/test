<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <meta name="description" content="This is a study plan website for students. Daily study schedules, tips, and learning guidance.">
  <meta name="keywords" content="study plan, education, student timetable, learning tips">
<meta name="author" content="Theekshana Vidu">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Tracker</title>
<link rel="icon" type="image/png" href="https://img.freepik.com/premium-vector/reading-owl-logo-simple-vector-design_609149-1053.jpg?semt=ais_hybrid&w=740&q=80">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{background:black;color:white;min-height:100vh;}
.input-field{padding:0.5rem;border-radius:0.5rem;background:#1e293b;border:none;color:white;width:100%;}
.liquid-btn{position:relative;padding:0.5rem 1.5rem;color:white;overflow:hidden;border:none;border-radius:1rem;background:#0ea5e9;cursor:pointer;font-weight:bold;margin:0.2rem;transition:0.3s;}
.liquid-btn::before{content:"";position:absolute;top:0;left:-100%;width:100%;height:100%;background:rgba(255,255,255,0.2);transform:skewX(-20deg);transition:0.5s;}
.liquid-btn:hover::before{left:100%;}
.liquid-btn:hover{box-shadow:0 0 20px #0ea5e9;}
.google-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 0.5rem 1.5rem; border: 2px solid #0ea5e9; border-radius: 0.5rem; background: transparent; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
.google-btn:hover { background: rgba(14, 165, 233, 0.1); box-shadow: 0 0 10px #0ea5e9; }
.google-logo { width: 20px; height: 20px; }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, addDoc, collection, getDocs, getDoc, query, where, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDYhulc8Qz_xGfIeb1g9A6BGO2wwbrz82M",
    authDomain: "study-9c374.firebaseapp.com",
    projectId: "study-9c374",
    storageBucket: "study-9c374.appspot.com",
    messagingSenderId: "82946998504",
    appId: "1:82946998504:web:290cd36a2559846891095d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const googleProvider = new GoogleAuthProvider();
const ADMIN_UID = "m1rddMA36WbVunFW3B0BzuqOwyI2";

let currentUser = null;
const appContainer = document.getElementById('app-container');
const headerGreeting = document.getElementById('header-greeting');
const headerButtons = document.getElementById('header-buttons');

// ---------- ROUTER SYSTEM (Hash Based) ----------
function navigateTo(path) {
    window.location.hash = path;
}

async function router() {
    const hashPath = window.location.hash.slice(1) || "/";
    const parts = hashPath.split('/').filter(p => p !== "");

    if (!currentUser && !['/login', '/register'].includes(hashPath)) {
        renderWelcome();
        return;
    }

    if (hashPath === "/login") renderLogin();
    else if (hashPath === "/register") renderRegister();
    else if (hashPath === "/home" || hashPath === "/") renderHome();
    else if (hashPath === "/profile") renderProfile();
    else if (hashPath === "/timetable") renderTimetable();
    else if (hashPath === "/adminpanel") renderAdmin();
    else if (hashPath === "/recordings") renderSubjects();
    else if (parts[0] === "recordings" && parts.length === 2) renderType(parts[1]);
    else if (parts[0] === "recordings" && parts.length === 3) renderLessons(parts[1], parts[2]);
    else if (parts[0] === "recordings" && parts.length === 4) openLessonPage(parts[1], parts[2], parts[3]);
    else renderHome();
}

window.addEventListener('hashchange', router);
window.addEventListener('load', router);

// ---------- Greeting ----------
function updateGreeting(){
  const name = currentUser?.displayName;
  const now = new Date();
  const h = now.getHours();
  let greet = h < 12 ? "Good Morning" : h < 17 ? "Good Afternoon" : "Good Evening";
  headerGreeting.textContent = `${name ? greet + " " + name : greet} | ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
}
setInterval(updateGreeting, 1000);

onAuthStateChanged(auth, u=>{
  currentUser = u;
  renderHeader();
  router();
});

function renderHeader(){
  headerButtons.innerHTML='';
  if(currentUser){
    headerButtons.appendChild(createLiquidButton("Home",()=>navigateTo('/home')));
    headerButtons.appendChild(createLiquidButton("Time Table", ()=>navigateTo('/timetable')));
    headerButtons.appendChild(createLiquidButton("Profile",()=>navigateTo('/profile')));
    if(currentUser.uid===ADMIN_UID) headerButtons.appendChild(createLiquidButton("Admin Panel",()=>navigateTo('/adminpanel')));
    headerButtons.appendChild(createLiquidButton("Logout", async ()=>await signOut(auth)));
  }else{
    headerButtons.appendChild(createLiquidButton("Login",()=>navigateTo('/login')));
    headerButtons.appendChild(createLiquidButton("Register",()=>navigateTo('/register')));
  }
}

function createLiquidButton(text, onClick){
  const btn = document.createElement('button');
  btn.className = 'liquid-btn'; btn.textContent = text; btn.onclick = onClick;
  return btn;
}

// ---------- PAGES ----------

function renderWelcome(){
  appContainer.innerHTML = `
  <div class="flex flex-col items-center justify-center h-full gap-6 text-center">
    <h2 class="text-3xl font-bold">Welcome to Study Tracker System</h2>
    <div class="flex gap-4"><button onclick="navigateTo('/login')" class="liquid-btn">Login</button><button onclick="navigateTo('/register')" class="liquid-btn bg-slate-700">Register</button></div>
  </div>`;
}

function renderRegister(){
  appContainer.innerHTML = `
  <div class="bg-slate-800 p-6 rounded-xl w-full max-w-md mx-auto space-y-3">
    <h2 class="text-2xl font-bold">Register</h2>
    <form id="reg-form" class="flex flex-col gap-2">
      <input name="firstName" placeholder="First Name" class="input-field" required>
      <input name="lastName" placeholder="Last Name" class="input-field" required>
      <input type="date" name="birthday" class="input-field" required>
      <input name="school" placeholder="School" class="input-field" required>
      <input name="phone" placeholder="Phone" class="input-field" required>
      <select name="examYear" class="input-field"><option>2026 A/L</option><option>2027 A/L</option><option>2028 A/L</option></select>
      <input type="email" name="email" placeholder="Email" class="input-field" required>
      <input type="password" name="password" placeholder="Password" class="input-field" required>
      <button type="submit" class="liquid-btn w-full">Register</button>
      <div id="reg-error" class="text-red-400"></div>
    </form>
  </div>`;
  document.getElementById('reg-form').onsubmit = async e=>{
    e.preventDefault();
    const f = e.target;
    try{
      const cred = await createUserWithEmailAndPassword(auth,f.email.value,f.password.value);
      await updateProfile(cred.user,{displayName: f.firstName.value + ' ' + f.lastName.value});
      await setDoc(doc(db,'users',cred.user.uid),{ firstName:f.firstName.value, lastName:f.lastName.value, birthday:f.birthday.value, school:f.school.value, phone:f.phone.value, examYear:f.examYear.value, email:f.email.value, createdAt:new Date().toISOString() });
      navigateTo('/home');
    }catch(err){ document.getElementById('reg-error').textContent = err.message; }
  };
}

function renderLogin(){
  appContainer.innerHTML = `
  <div class="bg-slate-800 p-6 rounded-xl w-full max-w-md mx-auto space-y-3 text-center">
    <h2 class="text-2xl font-bold">Login</h2>
    <form id="login-form" class="flex flex-col gap-2">
      <input type="email" name="email" placeholder="Email" class="input-field" required>
      <input type="password" name="password" placeholder="Password" class="input-field" required>
      <button type="submit" class="liquid-btn">Login</button>
      <div id="login-error" class="text-red-400"></div>
    </form>
    <button id="google-login" class="google-btn w-full mt-2"><img src="https://img.freepik.com/premium-vector/google-logo-icon-transparent-background_1273375-1570.jpg?semt=ais_hybrid&w=740&q=80" class="google-logo"> Continue with Google</button>
  </div>`;
  document.getElementById('login-form').onsubmit = async e=>{
    e.preventDefault();
    try{ await signInWithEmailAndPassword(auth,e.target.email.value,e.target.password.value); navigateTo('/home'); }
    catch(err){ document.getElementById('login-error').textContent = err.message; }
  };
  document.getElementById("google-login").onclick = async () => {
    try {
      const res = await signInWithPopup(auth, googleProvider);
      const snap = await getDoc(doc(db, "users", res.user.uid));
      if (snap.exists()) navigateTo('/home');
      else {
          // Google ‡∂¥‡∑è‡∑Ä‡∑í‡∂†‡∑ä‡∂†‡∑í ‡∂ö‡∂ª‡∂± ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂Ö‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂ö‡∑ô‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ Data save ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
          const names = res.user.displayName.split(" ");
          await setDoc(doc(db, "users", res.user.uid), { firstName: names[0]||"", lastName: names[1]||"", email: res.user.email, createdAt: new Date().toISOString() });
          navigateTo('/home');
      }
    } catch(err) { alert(err.message); }
  };
}

async function renderHome(){
  appContainer.innerHTML = `
  <div class="space-y-4 w-full max-w-xl mx-auto">
    <button onclick="navigateTo('/recordings')" class="liquid-btn w-full text-xl py-4 mb-4">üé• Recordings</button>
    <div class="bg-slate-800 p-6 rounded-xl space-y-4">
        <h2 class="text-2xl font-bold">Daily Study Entry</h2>
        <form id="daily-form" class="flex flex-col gap-2">
            <input type="date" name="date" value="${new Date().toISOString().slice(0,10)}" class="input-field" required>
            <input type="number" name="hours" placeholder="Hours studied" class="input-field" required>
            <button class="liquid-btn w-full">Save Entry</button>
        </form>
    </div>
    <canvas id="weekly-chart" class="bg-slate-800 rounded p-2"></canvas>
    <canvas id="monthly-chart" class="bg-slate-800 rounded p-2"></canvas>
  </div>`;
  
  document.getElementById('daily-form').onsubmit = async e=>{
    e.preventDefault();
    await addDoc(collection(db,'studyLogs'), {userId: currentUser.uid, date: e.target.date.value, hours: Number(e.target.hours.value), createdAt:new Date().toISOString()});
    renderCharts();
  };
  renderCharts();
}

// Chart Logic (As per your code)
async function renderCharts(){
  const snap = await getDocs(query(collection(db,'studyLogs'), where('userId','==',currentUser.uid)));
  const data = snap.docs.map(d=>d.data());
  const weekly=[], monthly={};
  const today = new Date();
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(today.getDate()-i);
    const ds = d.toISOString().slice(0,10);
    weekly.push(data.filter(x=>x.date===ds).reduce((a,b)=>a+b.hours,0));
  }
  data.forEach(x=>{ const m = x.date.slice(0,7); monthly[m] = (monthly[m] || 0) + x.hours; });

  new Chart(document.getElementById('weekly-chart'), { type:'line', data:{ labels:Array.from({length:7},(_,i)=>{const d=new Date(); d.setDate(today.getDate()-6+i); return d.toISOString().slice(5,10);}), datasets:[{label:'Weekly Hours', data:weekly, borderColor:'#8b5cf6', fill:true}] }, options:{ scales:{y:{beginAtZero:true, ticks:{color:'#fff'}}, x:{ticks:{color:'#fff'}}} } });
  new Chart(document.getElementById('monthly-chart'), { type:'line', data:{ labels:Object.keys(monthly), datasets:[{label:'Monthly Hours', data:Object.values(monthly), borderColor:'#22d3ee', fill:true}] }, options:{ scales:{y:{beginAtZero:true, ticks:{color:'#fff'}}, x:{ticks:{color:'#fff'}}} } });
}

// ---------- RECORDINGS SYSTEM ----------
function renderSubjects(){
  appContainer.innerHTML = `
    <h2 class="text-2xl font-bold mb-6">Select Subject</h2>
    <div class="flex flex-col gap-4">
      <button onclick="navigateTo('/recordings/maths')" class="flex items-center gap-4 bg-slate-800 p-4 rounded-xl hover:bg-slate-700 text-left">
        <img src="https://api.combinedmaths.lk/files-public/profiles/281124/1862199793225306112.jpg" class="w-16 h-16 rounded-xl object-cover">
        <span class="text-xl font-bold">Combine Maths - Ruwan Darshana</span>
      </button>
      <button onclick="navigateTo('/recordings/physics')" class="flex items-center gap-4 bg-slate-800 p-4 rounded-xl hover:bg-slate-700 text-left">
        <img src="https://static.indeepa.lk/lecturer/7/en/652248466c448.jpg" class="w-16 h-16 rounded-xl object-cover">
        <span class="text-xl font-bold">Physics - Anuradha Perera</span>
      </button>
      <button onclick="navigateTo('/recordings/chemistry')" class="flex items-center gap-4 bg-slate-800 p-4 rounded-xl hover:bg-slate-700 text-left">
        <img src="https://static.indeepa.lk/lecturer/6/en/6522475ddf2bf.jpg" class="w-16 h-16 rounded-xl object-cover">
        <span class="text-xl font-bold">Chemistry - Amila Dasanayake</span>
      </button>
    </div>`;
}

function renderType(subject){
  appContainer.innerHTML = `
    <h2 class="text-2xl font-bold mb-6 uppercase">${subject}</h2>
    <div class="flex gap-4">
      <button onclick="navigateTo('/recordings/${subject}/theory')" class="liquid-btn text-xl px-8 py-4">Theory</button>
      <button onclick="navigateTo('/recordings/${subject}/revision')" class="liquid-btn text-xl px-8 py-4">Revision</button>
    </div>`;
}

async function renderLessons(subject, type){
  appContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4 uppercase">${subject} - ${type}</h2><div id="lessons-list" class="flex flex-col gap-3"></div>`;
  const list = document.getElementById("lessons-list");
  
  const snap = await getDocs(query(collection(db,"lessons"), where("subject","==",subject), where("type","==",type)));
  let lessonsData = {};
  snap.forEach(doc => { lessonsData[doc.data().day] = doc.data().title; });

  for(let i=1; i<=20; i++){
    const day = String(i).padStart(2,"0");
    const title = lessonsData[day] || `Day ${day} - Lesson Title`;
    const row = document.createElement("div"); row.className = "flex gap-2 items-center";
    const btn = document.createElement("button"); btn.className = "liquid-btn flex-1 text-left";
    btn.textContent = title; btn.onclick = () => navigateTo(`/recordings/${subject}/${type}/${day}`);
    row.appendChild(btn);
    if(currentUser?.uid === ADMIN_UID){
        const editBtn = document.createElement("button"); editBtn.className="liquid-btn bg-yellow-600"; editBtn.textContent="‚úèÔ∏è";
        editBtn.onclick = async () => {
            const newName = prompt("New Name:", title);
            if(newName) { await setDoc(doc(db, "lessons", `${subject}_${type}_${day}`), {title: newName, subject, type, day}); renderLessons(subject, type); }
        };
        row.appendChild(editBtn);
    }
    list.appendChild(row);
  }
}

async function openLessonPage(subject, type, day){
  const lessonId = `${subject}_${type}_${day}`;
  appContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4">Lesson ${day} Content</h2><div id="content-list" class="flex flex-col gap-3 mb-6"></div>
  ${currentUser?.uid === ADMIN_UID ? `<div class="flex gap-2"><input id="c-text" placeholder="Text" class="input-field"><input id="c-link" placeholder="URL" class="input-field"><button id="add-c" class="liquid-btn">Add</button></div>` : ""}`;
  
  if(currentUser?.uid === ADMIN_UID){
      document.getElementById("add-c").onclick = async () => {
          const t = document.getElementById("c-text").value; const l = document.getElementById("c-link").value;
          const s = await getDocs(query(collection(db,"lessonContents"), where("lessonId","==",lessonId)));
          await addDoc(collection(db,"lessonContents"), {lessonId, text:t, link:l, order: s.size+1});
          openLessonPage(subject, type, day);
      };
  }
  const q = query(collection(db,"lessonContents"), where("lessonId","==",lessonId), orderBy("order","asc"));
  const snap = await getDocs(q);
  const list = document.getElementById("content-list");
  snap.forEach(dSnap => {
      const d = dSnap.data();
      const div = document.createElement("div"); div.className="bg-slate-800 p-3 rounded flex justify-between";
      div.innerHTML = `<a href="${d.link}" target="_blank" class="text-blue-400 underline">${d.text}</a>`;
      list.appendChild(div);
  });
}

// Timetable, Profile, Admin Panel functions should stay similar but use navigateTo() where needed.
async function renderProfile() { /* similar logic to yours */ }
async function renderTimetable() { /* similar logic to yours */ }
async function renderAdmin() { /* similar logic to yours */ }

window.navigateTo = navigateTo;
</script>
</head>
<body class="flex flex-col items-center p-4">
<header class="w-full p-4 bg-slate-900 shadow-lg flex justify-between items-center flex-wrap rounded-xl border border-slate-800">
  <h1 class="text-2xl font-bold cursor-pointer" onclick="navigateTo('/home')">StudyTracker</h1>
  <div id="header-greeting" class="text-sm opacity-70"></div>
  <div id="header-buttons" class="flex gap-2"></div>
</header>
<main class="flex-1 w-full max-w-4xl mt-6" id="app-container"></main>
<footer class="text-sm text-slate-500 mt-10">¬© Owner 2026</footer>
</body>
</html>
